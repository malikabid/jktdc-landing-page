{% extends 'layout/base.html.twig' %}

{% block title %}Edit Event - DOTK Admin{% endblock %}

{% block styles %}
<style>
    /* Simplified edit form styles */
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="page-header">
        <h1><i class="fas fa-edit"></i> Edit Event</h1>
        <a href="/admin/events" class="btn-back">
            <i class="fas fa-arrow-left"></i> Back to List
        </a>
    </div>
    
    <div class="form-card">
        <div id="loadingContainer" class="loading-container">
            <i class="fas fa-spinner fa-spin"></i>
            <p>Loading event details...</p>
        </div>
        
        <form id="eventForm" style="display: none;">
            <input type="hidden" id="eventId" value="{{ eventId }}">
            
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Title <span class="required">*</span></label>
                    <input type="text" class="form-control" id="title" name="title" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Category</label>
                    <select class="form-control" id="category" name="category">
                        <option value="">Select Category</option>
                        {% for category in categories %}
                        <option value="{{ category }}">{{ category }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group full-width">
                    <label class="form-label">Description</label>
                    <textarea class="form-control" id="description" name="description" rows="4" placeholder="Event details and information"></textarea>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Start Date <span class="required">*</span></label>
                    <input type="date" class="form-control" id="startDate" name="startDate" required>
                </div>
                <div class="form-group">
                    <label class="form-label">End Date</label>
                    <input type="date" class="form-control" id="endDate" name="endDate">
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Location</label>
                    <input type="text" class="form-control" id="location" name="location" placeholder="e.g., Dal Lake, Srinagar">
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Video URL</label>
                    <input type="url" class="form-control" id="videoUrl" name="videoUrl" placeholder="https://www.youtube.com/embed/...">
                </div>
                <div class="form-group">
                    <label class="form-label">Thumbnail URL</label>
                    <input type="url" class="form-control" id="thumbnail" name="thumbnail" placeholder="https://img.youtube.com/vi/...">
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group checkbox">
                    <input type="checkbox" id="showOnHomepage" name="showOnHomepage">
                    <label for="showOnHomepage">Show on Homepage</label>
                </div>
            </div>
            
            <div class="form-actions">
                <button type="submit" class="btn-primary" id="submitBtn">
                    <i class="fas fa-save"></i> Update Event
                </button>
                <a href="/admin/events" class="btn-secondary">
                    <i class="fas fa-times"></i> Cancel
                </a>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const eventId = document.getElementById('eventId').value;
    
    loadEventData();
    
    async function loadEventData() {
        try {
            const response = await fetch(`/admin/api/events/${eventId}`, {
                headers: { 'Authorization': `Bearer ${getToken()}` }
            });
            
            if (response.status === 401) {
                localStorage.removeItem('dotk_admin_token');
                window.location.href = '/admin/';
                return;
            }
            
            if (!response.ok) {
                showToast('Error', 'Failed to load event details', 'error');
                return;
            }
            
            const result = await response.json();
            const event = result.event || result;
            
            document.getElementById('title').value = event.title || '';
            document.getElementById('description').value = event.description || '';
            document.getElementById('startDate').value = event.startDate || '';
            document.getElementById('endDate').value = event.endDate || '';
            document.getElementById('location').value = event.location || '';
            document.getElementById('category').value = event.category || '';
            document.getElementById('videoUrl').value = event.videoUrl || '';
            document.getElementById('thumbnail').value = event.thumbnail || '';
            document.getElementById('showOnHomepage').checked = event.showOnHomepage || false;
            
            document.getElementById('loadingContainer').style.display = 'none';
            document.getElementById('eventForm').style.display = 'block';
            
        } catch (error) {
            console.error('Error:', error);
            showToast('Error', 'Network error loading event details', 'error');
        }
    }
    
    document.getElementById('eventForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const submitBtn = document.getElementById('submitBtn');
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Updating...';
        
        const formData = new FormData(this);
        const data = Object.fromEntries(formData);
        data.showOnHomepage = document.getElementById('showOnHomepage').checked;
        
        try {
            const response = await fetch(`/admin/api/events/${eventId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${getToken()}`
                },
                body: JSON.stringify(data)
            });
            
            if (response.status === 401) {
                localStorage.removeItem('dotk_admin_token');
                window.location.href = '/admin/';
                return;
            }
            
            if (!response.ok) {
                const result = await response.json();
                throw new Error(result.error || 'Failed to update event');
            }
            
            showToast('Success', 'Event updated successfully!', 'success');
            setTimeout(() => { window.location.href = '/admin/events'; }, 1500);
            
        } catch (error) {
            console.error('Error saving event:', error);
            showToast('Error', error.message || 'Failed to save event', 'error');
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-save"></i> Update Event';
        }
    });
</script>
{% endblock %}
