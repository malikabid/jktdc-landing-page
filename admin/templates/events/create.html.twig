{% extends 'layout/base.html.twig' %}

{% block title %}Add New Event - DOTK Admin{% endblock %}

{% block content %}
<div class="container">
    <div class="page-header">
        <h1><i class="fas fa-plus-circle"></i> Add New Event</h1>
        <a href="/admin/events" class="btn-back">
            <i class="fas fa-arrow-left"></i> Back to List
        </a>
    </div>
    
    <div class="form-card">
        <form id="eventForm">
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Title <span class="required">*</span></label>
                    <input type="text" class="form-control" id="title" name="title" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Category</label>
                    <select class="form-control" id="category" name="category">
                        <option value="">Select Category</option>
                        {% for category in categories %}
                        <option value="{{ category }}">{{ category }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group full-width">
                    <label class="form-label">Description</label>
                    <textarea class="form-control" id="description" name="description" rows="4" placeholder="Event details and information"></textarea>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Start Date <span class="required">*</span></label>
                    <input type="date" class="form-control" id="startDate" name="startDate" required>
                </div>
                <div class="form-group">
                    <label class="form-label">End Date</label>
                    <input type="date" class="form-control" id="endDate" name="endDate">
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Location</label>
                    <input type="text" class="form-control" id="location" name="location" placeholder="e.g., Dal Lake, Srinagar">
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Video URL</label>
                    <input type="url" class="form-control" id="videoUrl" name="videoUrl" placeholder="https://www.youtube.com/embed/...">
                </div>
                <div class="form-group">
                    <label class="form-label">Thumbnail URL</label>
                    <input type="url" class="form-control" id="thumbnail" name="thumbnail" placeholder="https://img.youtube.com/vi/...">
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group checkbox">
                    <input type="checkbox" id="showOnHomepage" name="showOnHomepage">
                    <label for="showOnHomepage">Show on Homepage</label>
                </div>
            </div>
            
            <div class="form-actions">
                <button type="submit" class="btn-primary" id="submitBtn">
                    <i class="fas fa-save"></i> Create Event
                </button>
                <a href="/admin/events" class="btn-secondary">
                    <i class="fas fa-times"></i> Cancel
                </a>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.getElementById('startDate').value = new Date().toISOString().split('T')[0];
    
    document.getElementById('eventForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const submitBtn = document.getElementById('submitBtn');
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating...';
        
        const currentToken = getToken();
        if (!currentToken) {
            showToast('Session Expired', 'Please login again.', 'error');
            setTimeout(() => { window.location.href = '/admin/'; }, 1500);
            return;
        }
        
        const formData = new FormData(this);
        const data = Object.fromEntries(formData);
        
        // Convert showOnHomepage checkbox to boolean
        data.showOnHomepage = formData.has('showOnHomepage');
        
        try {
            const response = await fetch('/admin/api/events', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${currentToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });
            
            const responseData = await response.json();
            
            if (!response.ok) {
                throw new Error(responseData.error || 'Failed to create event');
            }
            
            showToast('Success', 'Event created successfully!', 'success');
            setTimeout(() => {
                window.location.href = `/admin/events`;
            }, 1000);
            
        } catch (error) {
            console.error('Error saving event:', error);
            showToast('Error', error.message || 'Failed to save event', 'error');
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-save"></i> Create Event';
        }
    });
</script>
{% endblock %}
