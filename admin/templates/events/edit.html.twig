{% extends 'layout/base.html.twig' %}

{% block title %}Edit Event - DOTK Admin{% endblock %}

{% block styles %}
<style>
    .gallery-item {
        position: relative;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        overflow: hidden;
        background: #f9fafb;
    }
    
    .gallery-item img {
        width: 100%;
        height: 150px;
        object-fit: cover;
    }
    
    .gallery-item-actions {
        position: absolute;
        top: 0;
        right: 0;
        display: flex;
        gap: 5px;
        padding: 8px;
        background: rgba(0,0,0,0.5);
        opacity: 0;
        transition: opacity 0.2s;
    }
    
    .gallery-item:hover .gallery-item-actions {
        opacity: 1;
    }
    
    .gallery-btn {
        width: 32px;
        height: 32px;
        border: none;
        border-radius: 4px;
        background: rgba(255,255,255,0.9);
        color: #333;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
    }
    
    .gallery-btn:hover {
        background: white;
        transform: scale(1.1);
    }
    
    .featured-badge {
        position: absolute;
        top: 5px;
        left: 5px;
        background: #fbbf24;
        color: #78350f;
        padding: 3px 8px;
        border-radius: 4px;
        font-size: 0.7rem;
        font-weight: 700;
    }
    
    .gallery-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 15px;
        margin-top: 15px;
    }
    
    .image-upload-section {
        border: 2px dashed #e5e7eb;
        border-radius: 8px;
        padding: 20px;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .image-upload-section:hover {
        border-color: #9333ea;
        background: #faf5ff;
    }
    
    .image-upload-section.dragover {
        border-color: #9333ea;
        background: #faf5ff;
    }
    
    .image-upload-section input {
        display: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="page-header">
        <h1><i class="fas fa-edit"></i> Edit Event</h1>
        <a href="/admin/events" class="btn-back">
            <i class="fas fa-arrow-left"></i> Back to List
        </a>
    </div>
    
    <div class="form-card">
        <div id="loadingContainer" class="loading-container">
            <i class="fas fa-spinner fa-spin"></i>
            <p>Loading event details...</p>
        </div>
        
        <form id="eventForm" style="display: none;">
            <input type="hidden" id="eventId" value="{{ eventId }}">
            
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Title <span class="required">*</span></label>
                    <input type="text" class="form-control" id="title" name="title" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Short Description</label>
                    <input type="text" class="form-control" id="short_description" name="short_description" placeholder="Brief summary">
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group full-width">
                    <label class="form-label">Description</label>
                    <textarea class="form-control" id="description" name="description" rows="4"></textarea>
                </div>
            </div>
            
            <div class="form-row four-cols">
                <div class="form-group">
                    <label class="form-label">Event Date <span class="required">*</span></label>
                    <input type="date" class="form-control" id="event_date" name="event_date" required>
                </div>
                <div class="form-group">
                    <label class="form-label">End Date (Optional)</label>
                    <input type="date" class="form-control" id="event_end_date" name="event_end_date">
                </div>
                <div class="form-group">
                    <label class="form-label">Time</label>
                    <input type="time" class="form-control" id="event_time" name="event_time">
                </div>
                <div class="form-group">
                    <label class="form-label">Status</label>
                    <select class="form-control" id="status" name="status">
                        <option value="draft">Draft</option>
                        <option value="upcoming">Upcoming</option>
                        <option value="ongoing">Ongoing</option>
                        <option value="completed">Completed</option>
                        <option value="cancelled">Cancelled</option>
                    </select>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Location</label>
                    <input type="text" class="form-control" id="location" name="location" placeholder="e.g., Dal Lake, Srinagar">
                </div>
                <div class="form-group">
                    <label class="form-label">Event Type</label>
                    <select class="form-control" id="event_type" name="event_type">
                        <option value="general">General Event</option>
                        {% for key, label in types %}
                        <option value="{{ key }}">{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Category</label>
                    <select class="form-control" id="category" name="category">
                        <option value="">Select Category</option>
                        {% for category in categories %}
                        <option value="{{ category }}">{{ category }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Organizer</label>
                    <input type="text" class="form-control" id="organizer" name="organizer" placeholder="e.g., Directorate of Tourism Kashmir">
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Contact Person</label>
                    <input type="text" class="form-control" id="contact_person" name="contact_person">
                </div>
                <div class="form-group">
                    <label class="form-label">Contact Email</label>
                    <input type="email" class="form-control" id="contact_email" name="contact_email">
                </div>
                <div class="form-group">
                    <label class="form-label">Contact Phone</label>
                    <input type="tel" class="form-control" id="contact_phone" name="contact_phone">
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Latitude</label>
                    <input type="number" class="form-control" id="latitude" name="latitude" step="0.000001" placeholder="e.g., 34.1526">
                </div>
                <div class="form-group">
                    <label class="form-label">Longitude</label>
                    <input type="number" class="form-control" id="longitude" name="longitude" step="0.000001" placeholder="e.g., 74.8024">
                </div>
                <div class="form-group">
                    <label class="form-label">Registration URL</label>
                    <input type="url" class="form-control" id="registration_url" name="registration_url" placeholder="https://...">
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Video URL (Optional)</label>
                    <input type="url" class="form-control" id="video_url" name="video_url" placeholder="https://youtube.com/...">
                </div>
                <div class="form-group">
                    <label class="form-label">Meta Title</label>
                    <input type="text" class="form-control" id="meta_title" name="meta_title" maxlength="300">
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group full-width">
                    <label class="form-label">Meta Description</label>
                    <textarea class="form-control" id="meta_description" name="meta_description" rows="2" maxlength="500"></textarea>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group checkbox">
                    <input type="checkbox" id="featured" name="featured">
                    <label class="form-label" for="featured">
                        <i class="fas fa-star"></i> Mark as Featured Event
                    </label>
                </div>
            </div>
            
            <!-- Gallery Section -->
            <div class="gallery-section" id="gallerySection" style="display: none;">
                <h3><i class="fas fa-images"></i> Event Gallery</h3>
                <div class="image-upload-section" id="imageUploadSection">
                    <input type="file" id="imageInput" accept="image/*" multiple>
                    <i class="fas fa-cloud-upload-alt" style="font-size: 2rem; color: #9333ea;"></i>
                    <p style="margin-top: 10px; color: #64748b;">Drag and drop images here or click to select</p>
                </div>
                
                <div class="gallery-grid" id="galleryGrid"></div>
            </div>
            
            <div class="form-actions">
                <button type="submit" class="btn-primary" id="submitBtn">
                    <i class="fas fa-save"></i> Update Event
                </button>
                <a href="/admin/events" class="btn-secondary">
                    <i class="fas fa-times"></i> Cancel
                </a>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const eventId = document.getElementById('eventId').value;
    
    loadEventData();
    setupImageUpload();
    
    async function loadEventData() {
        try {
            const response = await fetch(`/admin/api/events/${eventId}`, {
                headers: { 'Authorization': `Bearer ${getToken()}` }
            });
            
            if (response.status === 401) {
                localStorage.removeItem('dotk_admin_token');
                window.location.href = '/admin/';
                return;
            }
            
            if (!response.ok) {
                showToast('Error', 'Failed to load event details', 'error');
                return;
            }
            
            const result = await response.json();
            const event = result.event || result;
            
            document.getElementById('title').value = event.title || '';
            document.getElementById('short_description').value = event.short_description || '';
            document.getElementById('description').value = event.description || '';
            document.getElementById('event_date').value = event.event_date ? event.event_date.split('T')[0] : '';
            document.getElementById('event_end_date').value = event.event_end_date ? event.event_end_date.split('T')[0] : '';
            document.getElementById('event_time').value = event.event_time || '';
            document.getElementById('location').value = event.location || '';
            document.getElementById('event_type').value = event.event_type || 'general';
            document.getElementById('category').value = event.category || '';
            document.getElementById('organizer').value = event.organizer || '';
            document.getElementById('contact_person').value = event.contact_person || '';
            document.getElementById('contact_email').value = event.contact_email || '';
            document.getElementById('contact_phone').value = event.contact_phone || '';
            document.getElementById('latitude').value = event.latitude || '';
            document.getElementById('longitude').value = event.longitude || '';
            document.getElementById('registration_url').value = event.registration_url || '';
            document.getElementById('video_url').value = event.video_url || '';
            document.getElementById('meta_title').value = event.meta_title || '';
            document.getElementById('meta_description').value = event.meta_description || '';
            document.getElementById('featured').checked = event.featured || false;
            document.getElementById('status').value = event.status || 'draft';
            
            // Load existing images
            if (event.images && event.images.length > 0) {
                const gallerySection = document.getElementById('gallerySection');
                const galleryGrid = document.getElementById('galleryGrid');
                gallerySection.style.display = 'block';
                
                galleryGrid.innerHTML = event.images.map(img => `
                    <div class="gallery-item" data-img-id="${img.id}">
                        ${event.image_path === img.image_path ? '<span class="featured-badge"><i class="fas fa-star"></i> Featured</span>' : ''}
                        <img src="${img.image_path}" alt="${img.alt_text || 'Event Image'}">
                        <div class="gallery-item-actions">
                            <button type="button" class="gallery-btn" onclick="setFeaturedImage(${img.id})" title="Set as featured">
                                <i class="fas fa-star"></i>
                            </button>
                            <button type="button" class="gallery-btn" onclick="deleteImage(${img.id})" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `).join('');
            }
            
            document.getElementById('loadingContainer').style.display = 'none';
            document.getElementById('eventForm').style.display = 'block';
            
        } catch (error) {
            console.error('Error:', error);
            showToast('Error', 'Network error loading event details', 'error');
        }
    }
    
    function setupImageUpload() {
        const uploadSection = document.getElementById('imageUploadSection');
        const imageInput = document.getElementById('imageInput');
        
        uploadSection.addEventListener('click', () => imageInput.click());
        
        uploadSection.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadSection.classList.add('dragover');
        });
        
        uploadSection.addEventListener('dragleave', () => {
            uploadSection.classList.remove('dragover');
        });
        
        uploadSection.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadSection.classList.remove('dragover');
            if (e.dataTransfer.files.length > 0) {
                imageInput.files = e.dataTransfer.files;
                uploadImages();
            }
        });
        
        imageInput.addEventListener('change', uploadImages);
    }
    
    async function uploadImages() {
        const imageInput = document.getElementById('imageInput');
        const files = imageInput.files;
        
        if (files.length === 0) return;
        
        for (const file of files) {
            if (!file.type.startsWith('image/')) {
                showToast('Error', 'Only image files are allowed', 'error');
                continue;
            }
            
            const formData = new FormData();
            formData.append('image', file);
            formData.append('alt_text', file.name);
            
            try {
                const response = await fetch(`/admin/api/events/${eventId}/images`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${getToken()}` },
                    body: formData
                });
                
                if (!response.ok) {
                    const data = await response.json();
                    throw new Error(data.error || 'Failed to upload image');
                }
                
                const result = await response.json();
                addImageToGallery(result.image);
                showToast('Success', 'Image uploaded successfully', 'success');
                
            } catch (error) {
                console.error('Error uploading image:', error);
                showToast('Error', error.message || 'Failed to upload image', 'error');
            }
        }
        
        imageInput.value = '';
    }
    
    function addImageToGallery(image) {
        const gallerySection = document.getElementById('gallerySection');
        const galleryGrid = document.getElementById('galleryGrid');
        gallerySection.style.display = 'block';
        
        if (galleryGrid.children.length === 0 || galleryGrid.innerHTML.includes('No images')) {
            galleryGrid.innerHTML = '';
        }
        
        const item = document.createElement('div');
        item.className = 'gallery-item';
        item.dataset.imgId = image.id;
        item.innerHTML = `
            <img src="${image.image_path}" alt="${image.alt_text || 'Event Image'}">
            <div class="gallery-item-actions">
                <button type="button" class="gallery-btn" onclick="setFeaturedImage(${image.id})" title="Set as featured">
                    <i class="fas fa-star"></i>
                </button>
                <button type="button" class="gallery-btn" onclick="deleteImage(${image.id})" title="Delete">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        `;
        galleryGrid.appendChild(item);
    }
    
    async function setFeaturedImage(imgId) {
        try {
            const response = await fetch(`/admin/api/events/${eventId}/images/${imgId}/featured`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${getToken()}` }
            });
            
            if (!response.ok) throw new Error('Failed to set featured image');
            
            // Remove featured badge from all images
            document.querySelectorAll('.featured-badge').forEach(badge => badge.remove());
            
            // Add featured badge to selected image
            const item = document.querySelector(`[data-img-id="${imgId}"]`);
            const badge = document.createElement('span');
            badge.className = 'featured-badge';
            badge.innerHTML = '<i class="fas fa-star"></i> Featured';
            item.appendChild(badge);
            
            showToast('Success', 'Featured image updated', 'success');
            
        } catch (error) {
            console.error('Error:', error);
            showToast('Error', 'Failed to set featured image', 'error');
        }
    }
    
    async function deleteImage(imgId) {
        if (!confirm('Are you sure you want to delete this image?')) return;
        
        try {
            const response = await fetch(`/admin/api/events/${eventId}/images/${imgId}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${getToken()}` }
            });
            
            if (!response.ok) throw new Error('Failed to delete image');
            
            document.querySelector(`[data-img-id="${imgId}"]`).remove();
            showToast('Success', 'Image deleted successfully', 'success');
            
        } catch (error) {
            console.error('Error:', error);
            showToast('Error', 'Failed to delete image', 'error');
        }
    }
    
    document.getElementById('eventForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const submitBtn = document.getElementById('submitBtn');
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
        
        const currentToken = getToken();
        if (!currentToken) {
            showToast('Session Expired', 'Please login again.', 'error');
            setTimeout(() => { window.location.href = '/admin/'; }, 1500);
            return;
        }
        
        const formData = new FormData(this);
        const data = Object.fromEntries(formData);
        data.featured = document.getElementById('featured').checked;
        
        try {
            const response = await fetch(`/admin/api/events/${eventId}`, {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${currentToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });
            
            const responseData = await response.json();
            
            if (!response.ok) {
                throw new Error(responseData.error || 'Failed to update event');
            }
            
            showToast('Success', 'Event updated successfully!', 'success');
            
        } catch (error) {
            console.error('Error saving event:', error);
            showToast('Error', error.message || 'Failed to save event', 'error');
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-save"></i> Update Event';
        }
    });
</script>
{% endblock %}
