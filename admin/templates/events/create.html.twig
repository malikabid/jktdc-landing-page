{% extends 'layout/base.html.twig' %}

{% block title %}Add New Event - DOTK Admin{% endblock %}

{% block content %}
<div class="container">
    <div class="page-header">
        <h1><i class="fas fa-plus-circle"></i> Add New Event</h1>
        <a href="/admin/events" class="btn-back">
            <i class="fas fa-arrow-left"></i> Back to List
        </a>
    </div>
    
    <div class="form-card">
        <form id="eventForm">
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Title <span class="required">*</span></label>
                    <input type="text" class="form-control" id="title" name="title" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Category</label>
                    <select class="form-control" id="category" name="category">
                        <option value="">Select Category</option>
                        {% for category in categories %}
                        <option value="{{ category }}">{{ category }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group full-width">
                    <label class="form-label">Description</label>
                    <textarea class="form-control" id="description" name="description" rows="4" placeholder="Event details and information"></textarea>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Start Date <span class="required">*</span></label>
                    <input type="date" class="form-control" id="startDate" name="startDate" required>
                </div>
                <div class="form-group">
                    <label class="form-label">End Date</label>
                    <input type="date" class="form-control" id="endDate" name="endDate">
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Location</label>
                    <input type="text" class="form-control" id="location" name="location" placeholder="e.g., Dal Lake, Srinagar">
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Video URL</label>
                    <input type="url" class="form-control" id="videoUrl" name="videoUrl" placeholder="https://www.youtube.com/embed/...">
                </div>
                <div class="form-group">
                    <label class="form-label">Thumbnail URL</label>
                    <input type="url" class="form-control" id="thumbnail" name="thumbnail" placeholder="https://img.youtube.com/vi/...">
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group full-width">
                    <div class="themed-upload-container" style="background: #fffbe6; border: 2px solid #f6c453; border-radius: 10px; padding: 18px 18px 10px 18px; margin-bottom: 10px;">
                        <label class="form-label" style="color: #a86a00; font-weight: 600; font-size: 1.1rem;">
                            <i class="fas fa-paperclip"></i> Event Document
                        </label>
                        <input type="file" class="form-control" id="file_upload" name="file_upload" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png,.gif,.mp4,.avi,.mov" style="margin-top: 10px;">
                        <small class="form-text" style="color: #a86a00;">Allowed: Images (JPG, PNG, GIF), Documents (PDF, DOC, DOCX), Videos (MP4, AVI, MOV) - Max 50MB</small>
                        <div id="currentFile" style="margin-top: 10px; display: none; background: #fff; border-radius: 6px; padding: 8px 12px; box-shadow: 0 2px 8px #f6c45333; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-file" style="color: #f6c453; font-size: 1.3rem;"></i>
                            <span id="fileName" style="font-weight: 500; color: #a86a00;"></span>
                            <button type="button" class="btn btn-danger btn-sm" onclick="removeFile()" style="margin-left: auto;">Delete</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">CTA Button Text</label>
                    <input type="text" class="form-control" id="cta_text" name="cta_text" placeholder="e.g., Register Now, Download Brochure, Learn More">
                </div>
                <div class="form-group">
                    <label class="form-label">CTA Button Link</label>
                    <input type="url" class="form-control" id="cta_link" name="cta_link" placeholder="https://...">
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group checkbox">
                    <input type="checkbox" id="showOnHomepage" name="showOnHomepage">
                    <label for="showOnHomepage">Show on Homepage</label>
                </div>
            </div>
            
            <div class="form-actions">
                <button type="submit" class="btn-primary" id="submitBtn">
                    <i class="fas fa-save"></i> Create Event
                </button>
                <a href="/admin/events" class="btn-secondary">
                    <i class="fas fa-times"></i> Cancel
                </a>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.getElementById('startDate').value = new Date().toISOString().split('T')[0];
    
    document.getElementById('eventForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const submitBtn = document.getElementById('submitBtn');
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating...';
        
        const currentToken = getToken();
        if (!currentToken) {
            showToast('Session Expired', 'Please login again.', 'error');
            setTimeout(() => { window.location.href = '/admin/'; }, 1500);
            return;
        }
        
        const formData = new FormData(this);
        const data = Object.fromEntries(formData);
        
        // Convert showOnHomepage checkbox to boolean
        data.showOnHomepage = formData.has('showOnHomepage');
        
        try {
            const response = await fetch('/admin/api/events', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${currentToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });
            
            const responseData = await response.json();
            
            if (!response.ok) {
                throw new Error(responseData.error || 'Failed to create event');
            }
            
            showToast('Success', 'Event created successfully!', 'success');
            setTimeout(() => {
                window.location.href = `/admin/events`;
            }, 1000);
            
        } catch (error) {
            console.error('Error saving event:', error);
            showToast('Error', error.message || 'Failed to save event', 'error');
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-save"></i> Create Event';
        }
    });
</script>
{% endblock %}
